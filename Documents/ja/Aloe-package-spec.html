<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Aloe パッケージ仕様書（ドラフト、日本語版）</title>
  <meta name="edit-version" content="1" />
  <meta name="edit-date" content="2025-12-04T09:30:00+09:00" />
  <style>
    :root {
      color-scheme: light dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   "Hiragino Sans", "Yu Gothic", sans-serif;
      line-height: 1.7;
      color: #111827;
      background: #f5f5f7;
    }
    .layout {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 280px;
      background: #111827;
      color: #e5e7eb;
      padding: 1.5rem 1.25rem 2.5rem;
      position: sticky;
      top: 0;
      align-self: flex-start;
      max-height: 100vh;
      overflow-y: auto;
    }
    .sidebar h1 {
      font-size: 1.1rem;
      margin: 0 0 0.4rem;
    }
    .sidebar .subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 1.4rem;
    }
    .sidebar h2 {
      font-size: 0.85rem;
      margin: 1.2rem 0 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }
    .sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.9rem;
    }
    .sidebar nav li {
      margin: 0.18rem 0;
    }
    .sidebar a {
      color: inherit;
      text-decoration: none;
      display: block;
      padding: 0.25rem 0.45rem;
      border-radius: 0.35rem;
    }
    .sidebar a:hover {
      background: #1f2937;
    }
    .chapter-index {
      font-family: "JetBrains Mono", "Cascadia Code", Consolas, monospace;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-right: 0.35rem;
    }

    .content {
      flex: 1;
      max-width: 1100px;
      padding: 2rem 3rem 3rem;
      margin: 0 auto;
      background: #f9fafb;
    }
    h1, h2, h3, h4, h5 {
      color: #111827;
      margin-top: 1.6em;
    }
    h1 {
      margin-top: 0;
    }
    p {
      margin-top: 0.4em;
      margin-bottom: 0.7em;
    }
    ul, ol {
      padding-left: 1.4em;
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    pre, code {
      font-family: "JetBrains Mono", "Cascadia Code", Consolas,
                   "Ricty Diminished", monospace;
      font-size: 0.9rem;
    }
    pre {
      background: #1118270d;
      padding: 0.8rem 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      border: 1px solid #e5e7eb;
      margin: 0.9em 0;
    }
    hr {
      margin: 2.2rem 0;
      border: none;
      border-top: 1px solid #e5e7eb;
    }
    .note {
      font-size: 0.9rem;
      color: #4b5563;
    }
    .badge {
      display: inline-block;
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      margin-left: 0.4rem;
    }
    .badge-stable {
      background: #d1fae5;
      color: #065f46;
    }
    .badge-draft {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
<div class="layout">

  <aside class="sidebar">
    <h1>Aloe Package Spec</h1>
    <div class="subtitle">
      Draft • Japanese • パッケージフォーマット仕様<br>
      （ビルドツール仕様は別文書）
    </div>

    <h2>Chapters</h2>
    <nav>
      <ul>
        <li><a href="#ch0"><span class="chapter-index">0.</span>概要とスコープ</a></li>
        <li><a href="#ch1"><span class="chapter-index">1.</span>基本概念</a></li>
        <li><a href="#ch2"><span class="chapter-index">2.</span>パッケージ構成</a></li>
        <li><a href="#ch3"><span class="chapter-index">3.</span><code>&lt;package&gt;.meta.json</code></a></li>
        <li><a href="#ch4"><span class="chapter-index">4.</span>パッケージDB <code>package-db.json</code></a></li>
        <li><a href="#ch5"><span class="chapter-index">5.</span>バージョンと互換性</a></li>
        <li><a href="#ch6"><span class="chapter-index">6.</span>コンパイラ／ツールとの関係</a></li>
        <li><a href="#appendix"><span class="chapter-index">A.</span>編集ポリシー（生成AI向け）</a></li>
      </ul>
    </nav>
  </aside>

  <main class="content">
    <h1 id="top">Aloe パッケージ仕様書（ドラフト、日本語版）</h1>
    <p class="note">
      この文書は、Aloe 言語および AloeVM を取り巻く
      <strong>「パッケージ」レベルの仕様</strong>を定義する。<br>
      ここでいう「パッケージ」とは、Aloe のモジュール群をコンパイルした
      <code>.abc</code> ファイルと、そのメタデータ (<code>.meta.json</code>) の組を指す。<br>
      ビルドツール（例：<code>aloec</code>）のコマンドライン仕様やプロジェクトファイル形式は、
      <strong>別途「ビルドツール仕様書」</strong>で定義する。
    </p>

    <hr>

    <h2 id="ch0">0. 概要とスコープ</h2>

    <h3>0.1 この仕様書の目的</h3>
    <ul>
      <li>Aloe 向けのパッケージフォーマットを統一し、複数のコンパイラ／ビルドツール／IDE から共通に扱えるようにする。</li>
      <li>バイナリコード (<code>.abc</code>) に加えて、型情報・シグニチャ情報・依存関係などを JSON 形式で提供する。</li>
      <li>ソースコードがなくても、<code>.meta.json</code> だけで最低限の補完や静的チェックが行えることを目指す。</li>
    </ul>

    <h3>0.2 対象外（この仕様書が扱わないもの）</h3>
    <ul>
      <li>Aloe 言語の構文・型システム・ランタイム意味論
        <ul>
          <li>→ 「Aloe 言語仕様書」を参照。</li>
        </ul>
      </li>
      <li>AloeVM の命令セット・スタック構造・<code>.abc</code> ファイルのバイナリレイアウト
        <ul>
          <li>→ 「AloeVM 仕様書」を参照。</li>
        </ul>
      </li>
      <li>ビルドツール（<code>aloec</code> など）のコマンドラインオプションや挙動
        <ul>
          <li>→ 「Aloe ビルドツール仕様書（予定）」で定義する。</li>
        </ul>
      </li>
    </ul>

    <h3>0.3 安定度とバージョン</h3>
    <p>
      本仕様書はドラフトであり、実装経験に応じて変更される可能性がある。<br>
      ただし、<strong><code>.meta.json</code> および <code>package-db.json</code> の構造は、
      一度採用したら安易に破壊的変更を行わない</strong>方針とする。
    </p>

    <hr>

    <h2 id="ch1">1. 基本概念</h2>

    <h3>1.1 パッケージ</h3>
    <p>
      Aloe における「パッケージ」は、主に次の 2 つのファイルの組で構成される：
    </p>
    <ul>
      <li><code>&lt;package&gt;.abc</code>
        <ul>
          <li>AloeVM が直接実行するバイトコードファイル（Aloe ByteCode）。</li>
          <li>具体的なバイナリ構造は AloeVM 仕様書で定義される。</li>
        </ul>
      </li>
      <li><code>&lt;package&gt;.meta.json</code>
        <ul>
          <li>パッケージ内の公開シンボル（クラス・struct・enum・関数・メソッド・フィルタ・アノテーションなど）のメタ情報。</li>
          <li>この仕様書で JSON スキーマを定義する。</li>
        </ul>
      </li>
    </ul>

    <h3>1.2 パッケージ名とバージョン</h3>
    <ul>
      <li>パッケージ名は <code>aloe.system</code> のような <strong>ドット区切りの小文字名前空間</strong>を推奨する。</li>
      <li>バージョンは慣例的に <code>MAJOR.MINOR.PATCH</code> 形式（例：<code>1.2.0</code>）とする。</li>
      <li>バージョンレンジの表記（<code>&gt;=1.0.0 &lt;2.0.0</code> 等）については、ツール側仕様（ビルドツール仕様書）で詳細を定義する。</li>
    </ul>

    <h3>1.3 パッケージ DB</h3>
    <p>
      ビルド時や実行時に参照するための「パッケージデータベース」は、
      <code>package-db.json</code> という単一の JSON ファイルで表現する。<br>
      これは複数パッケージについて、
      「どのパスに <code>.abc</code> と <code>.meta.json</code> が存在するか」を集約したインデックスである。
    </p>

    <hr>

    <h2 id="ch2">2. パッケージ構成</h2>

    <h3>2.1 ファイル構成の例</h3>
    <pre><code>myapp.core.abc           // AloeVM が実行するバイトコード
myapp.core.meta.json     // パッケージメタ情報（本仕様書で定義）
myapp.util.abc
myapp.util.meta.json
package-db.json          // パッケージデータベース（4章参照）
</code></pre>

    <h3>2.2 .abc と .meta.json の関係</h3>
    <ul>
      <li><code>.abc</code> … 実際のコードとデータ（AloeVM 仕様書で定義）。</li>
      <li><code>.meta.json</code> … 型・関数シグニチャ・依存関係の「宣言情報」。
        <ul>
          <li>ツール（コンパイラ・IDE・静的解析器など）は、原則として <code>.abc</code> を解釈せず、
              <code>.meta.json</code> を一次情報として利用する。</li>
          <li><code>.abc</code> と <code>.meta.json</code> は論理的に一体だが、ファイルとしては分離される。</li>
        </ul>
      </li>
    </ul>

    <hr>

    <h2 id="ch3">3. <code>&lt;package&gt;.meta.json</code> 仕様</h2>

    <h3>3.1 トップレベル構造</h3>
    <pre><code>{
  "formatVersion": 1,
  "package": { ... },
  "source": { ... },
  "dependencies": [ ... ],
  "exports": {
    "types":       [ ... ],
    "functions":   [ ... ],
    "methods":     [ ... ],
    "filters":     [ ... ],
    "annotations": [ ... ]
  }
}
</code></pre>
    <ul>
      <li><code>formatVersion</code>
        <ul>
          <li>この JSON フォーマット自体のバージョンを表す整数。</li>
          <li>破壊的変更を行う場合のみインクリメントする。</li>
        </ul>
      </li>
    </ul>

    <h3>3.2 <code>package</code> セクション</h3>
    <pre><code>"package": {
  "name": "myapp.core",
  "version": "0.1.0",
  "build": {
    "configuration": "Debug",          // "Debug" / "Release" など
    "compiler": "aloec",               // 使用したコンパイラ名
    "compilerVersion": "0.1.0",        // コンパイラバージョン
    "buildTime": "2025-12-04T09:30:00Z"
  }
}
</code></pre>
    <ul>
      <li><code>name</code> … パッケージ名。</li>
      <li><code>version</code> … パッケージバージョン。</li>
      <li><code>build</code> … ビルドに関するメタ情報。
        <ul>
          <li>コンパイラ名やビルド時刻は、ツールのデバッグに役立つが、言語仕様的な意味は持たない。</li>
        </ul>
      </li>
    </ul>

    <h3>3.3 <code>source</code> セクション</h3>
    <pre><code>"source": {
  "files": [
    "src/Main.as",
    "src/App.as"
  ]
}
</code></pre>
    <ul>
      <li>このパッケージを構成した Aloe ソースファイルの相対パス一覧。</li>
      <li>利用者がソースにアクセスできない環境では、空配列としてもよい。</li>
    </ul>

    <h3>3.4 <code>dependencies</code> セクション</h3>
    <pre><code>"dependencies": [
  {
    "name": "aloe.system",
    "versionRange": "&gt;=0.1.0"
  },
  {
    "name": "myapp.util",
    "versionRange": "0.2.x"
  }
]
</code></pre>
    <ul>
      <li><code>name</code> … 依存パッケージ名。</li>
      <li><code>versionRange</code> … 要求されるバージョンレンジ（書式はビルドツール仕様で定義）。</li>
      <li>依存解決は主にビルドツール側の責務だが、その際の元情報として <code>.meta.json</code> を利用する。</li>
    </ul>

    <hr>

    <h3>3.5 <code>exports.types</code>：型情報</h3>
    <pre><code>"exports": {
  "types": [
    {
      "kind": "class",
      "namespace": "MyApp",
      "name": "App",
      "visibility": "public"
    },
    {
      "kind": "enum",
      "namespace": "MyApp.Logging",
      "name": "LogLevel",
      "visibility": "public",
      "underlyingType": "int",
      "members": [
        {
          "name": "Debug",
          "value": 1,
          "bitIndex": null,
          "isAlias": false,
          "documentation": "Debug level"
        },
        {
          "name": "Info",
          "value": 2,
          "bitIndex": null,
          "isAlias": false,
          "documentation": "Information level"
        }
      ]
    },
    {
      "kind": "bitfield-enum",
      "namespace": "MyApp.Logging",
      "name": "LogFlags",
      "visibility": "public",
      "underlyingType": "int",
      "members": [
        {
          "name": "None",
          "value": 1,
          "bitIndex": 0,
          "isAlias": false,
          "documentation": null
        },
        {
          "name": "Info",
          "value": 8,
          "bitIndex": 3,
          "isAlias": false,
          "documentation": null
        }
      ]
    }
  ],
  ...
}
</code></pre>

    <h4>3.5.1 共通フィールド</h4>
    <ul>
      <li><code>kind</code>
        <ul>
          <li><code>"class"</code>, <code>"struct"</code>, <code>"interface"</code>,
              <code>"trait"</code>, <code>"enum"</code>, <code>"bitfield-enum"</code>,
              <code>"annotation"</code> のいずれか。</li>
        </ul>
      </li>
      <li><code>namespace</code> … 完全修飾名の名前空間部分（例：<code>"MyApp.Logging"</code>）。</li>
      <li><code>name</code> … 型名（例：<code>"App"</code>）。</li>
      <li><code>visibility</code> … 現時点では <code>"public"</code> または <code>"internal"</code>。</li>
    </ul>

    <h4>3.5.2 enum / bitfield enum の追加フィールド</h4>
    <ul>
      <li><code>underlyingType</code>
        <ul>
          <li>Aloe 言語仕様上、現時点では常に <code>"int"</code> とする。</li>
        </ul>
      </li>
      <li><code>members</code>（配列）
        <ul>
          <li><code>name</code> … 列挙子名。</li>
          <li><code>value</code> … 列挙子の実際の <code>int</code> 値（暗黙の連番や <code>b(n)</code> を展開済み）。</li>
          <li><code>bitIndex</code>
            <ul>
              <li><code>kind: "bitfield-enum"</code> のときのみ 0–31 のビット位置。</li>
              <li>通常の enum の場合は <code>null</code> か省略。</li>
            </ul>
          </li>
          <li><code>isAlias</code> … 他の列挙子と同じ <code>value</code> を共有する別名なら <code>true</code>。</li>
          <li><code>documentation</code> … 将来的な doc コメント用の文字列（任意）。</li>
        </ul>
      </li>
    </ul>

    <hr>

    <h3>3.6 <code>exports.functions</code>：トップレベル関数</h3>
    <pre><code>"functions": [
  {
    "namespace": "MyApp",
    "name": "MainHelper",
    "visibility": "internal",
    "parameters": [
      { "name": "x", "type": "int" },
      { "name": "y", "type": "int" }
    ],
    "returnType": "int",
    "isAsync": false,
    "attributes": []
  }
]
</code></pre>
    <ul>
      <li><code>namespace</code>, <code>name</code>, <code>visibility</code> は型と同様。</li>
      <li><code>parameters</code>
        <ul>
          <li><code>name</code> … パラメータ名。</li>
          <li><code>type</code> … Aloe 型の文字列表現（例：<code>"int"</code>, <code>"string[]"</code>, <code>"MyApp.User"</code>）。</li>
        </ul>
      </li>
      <li><code>returnType</code> … 戻り値の型（<code>"void"</code> を含む）。</li>
      <li><code>isAsync</code> … <code>async</code> 関数であれば <code>true</code>。</li>
      <li><code>attributes</code> … 将来拡張用のメタ情報（当面は空配列でよい）。</li>
    </ul>

    <hr>

    <h3>3.7 <code>exports.methods</code>：メソッド</h3>
    <pre><code>"methods": [
  {
    "ownerType": "MyApp.App",           // 完全修飾型名
    "name": "Run",
    "visibility": "public",
    "isStatic": false,
    "isAsync": false,
    "parameters": [
      { "name": "args", "type": "string[]" }
    ],
    "returnType": "void",
    "attributes": []
  }
]
</code></pre>
    <ul>
      <li><code>ownerType</code> … <code>namespace.name</code> 形式の完全修飾名。</li>
      <li><code>name</code>, <code>visibility</code>, <code>parameters</code>, <code>returnType</code>, <code>isAsync</code> は関数と同様。</li>
      <li><code>isStatic</code> … <code>static method</code> であれば <code>true</code>。</li>
    </ul>

    <hr>

    <h3>3.8 <code>exports.filters</code>：フィルタ</h3>
    <pre><code>"filters": [
  {
    "name": "json&lt;T&gt;",
    "namespace": "aloe.json",
    "visibility": "public",
    "inputType": "pipe&lt;byte&gt;",
    "outputType": "pipe&lt;T&gt;",
    "optionsType": "aloe.json.JsonOptions",
    "attributes": []
  }
]
</code></pre>
    <ul>
      <li><code>name</code> … フィルタ名（ジェネリックならその表現を含めてもよい）。</li>
      <li><code>namespace</code>, <code>visibility</code> … 他と同様。</li>
      <li><code>inputType</code>, <code>outputType</code> … 入出力の Aloe 型文字列表現。</li>
      <li><code>optionsType</code> … フィルタのオプション型（bitfield enum 等）があればその完全修飾名、なければ <code>null</code>。</li>
    </ul>

    <hr>

    <h3>3.9 <code>exports.annotations</code>：アノテーション</h3>
    <pre><code>"annotations": [
  {
    "name": "StructLayout",
    "namespace": "aloe.runtime",
    "visibility": "public",
    "targetKinds": [ "struct" ],
    "description": "struct のメモリレイアウトを指定するアノテーション"
  }
]
</code></pre>
    <ul>
      <li><code>name</code>, <code>namespace</code>, <code>visibility</code> … 他と同様。</li>
      <li><code>targetKinds</code> … このアノテーションを付与できる対象種別（例：<code>"struct"</code>, <code>"class"</code>, <code>"method"</code> など）。</li>
      <li><code>description</code> … 簡単な説明文（任意）。</li>
    </ul>

    <hr>

    <h2 id="ch4">4. パッケージ DB <code>package-db.json</code></h2>

    <h3>4.1 トップレベル構造</h3>
    <pre><code>{
  "formatVersion": 1,
  "packages": [
    {
      "name": "myapp.core",
      "version": "0.1.0",
      "abcPath": "packages/myapp.core.abc",
      "metaPath": "packages/myapp.core.meta.json",
      "dependencies": [
        { "name": "aloe.system", "versionRange": "&gt;=0.1.0" }
      ]
    }
  ]
}
</code></pre>
    <ul>
      <li><code>formatVersion</code> … このファイル形式のバージョン。</li>
      <li><code>packages</code> … 利用可能なパッケージの一覧。</li>
    </ul>

    <h3>4.2 各パッケージエントリ</h3>
    <ul>
      <li><code>name</code> … パッケージ名。</li>
      <li><code>version</code> … パッケージバージョン。</li>
      <li><code>abcPath</code> … <code>.abc</code> ファイルへのパス（<code>package-db.json</code> からの相対パス、または絶対パス）。</li>
      <li><code>metaPath</code> … 対応する <code>.meta.json</code> へのパス。</li>
      <li><code>dependencies</code> … そのパッケージが必要とする他パッケージの依存関係。
        <ul>
          <li>構造は <code>.meta.json</code> 内の <code>dependencies</code> と同じだが、
              ビルドや実行時の解決を容易にするためにこちらにも複製しておく。</li>
        </ul>
      </li>
    </ul>

    <p>
      ビルドツールは通常、<code>.meta.json</code> から依存情報を読み取りつつ、
      <code>package-db.json</code> からパッケージの物理パスを取得する。
    </p>

    <hr>

    <h2 id="ch5">5. バージョンと互換性</h2>

    <h3>5.1 <code>formatVersion</code> の扱い</h3>
    <ul>
      <li><code>.meta.json</code> と <code>package-db.json</code> の両方に <code>formatVersion</code> が存在する。</li>
      <li>これらは「JSON フォーマット自体」のバージョンであり、Aloe 言語のバージョンとは独立である。</li>
      <li>フィールドの追加など後方互換な変更では、原則として <code>formatVersion</code> は据え置きとし、
          破壊的変更が入る場合のみインクリメントする。</li>
    </ul>

    <h3>5.2 パッケージのバージョン互換性</h3>
    <ul>
      <li>パッケージの <code>version</code> フィールドは、API の互換性レベルを表すために用いることができる。</li>
      <li>enum メンバーの追加・削除・値変更なども、<code>.meta.json</code> の差分から機械的に検出可能であり、
          将来的には「互換性チェッカー」ツールによる自動検査を想定する。</li>
    </ul>

    <hr>

    <h2 id="ch6">6. コンパイラ／ツールとの関係</h2>

    <h3>6.1 コンパイラの責務</h3>
    <ul>
      <li>Aloe コンパイラは、ソースコードをコンパイルする際に：
        <ul>
          <li><code>&lt;package&gt;.abc</code>（バイトコード）を出力する。</li>
          <li><code>&lt;package&gt;.meta.json</code>（本仕様に準拠したメタ情報）を同時に出力する。</li>
        </ul>
      </li>
      <li>メタ情報には、少なくとも公開シンボル（<code>public</code>）に関する情報を含めることが推奨される。</li>
    </ul>

    <h3>6.2 ツールの利用パターン</h3>
    <ul>
      <li>ビルドツール：
        <ul>
          <li>依存解決のために <code>.meta.json</code> の <code>dependencies</code> を読み取る。</li>
          <li>パッケージ検索と解決のために <code>package-db.json</code> を利用する。</li>
        </ul>
      </li>
      <li>IDE / LSP：
        <ul>
          <li>補完・シグネチャヘルプのために <code>exports.types</code>, <code>exports.functions</code>,
              <code>exports.methods</code>, <code>exports.filters</code>, <code>exports.annotations</code> を参照する。</li>
          <li>enum / bitfield enum のメンバー一覧と値を表示するために <code>members</code> 配列を利用する。</li>
        </ul>
      </li>
      <li>静的解析ツール：
        <ul>
          <li>破壊的変更の検出や API 互換性チェックに <code>.meta.json</code> の差分を利用する。</li>
        </ul>
      </li>
    </ul>

    <hr>

    <h2 id="appendix">Appendix: 生成AI向け編集ポリシー（この仕様書専用）</h2>
    <p class="note">
      この節は Aloe パッケージ仕様書を生成 AI で編集する際の内規であり、
      仕様本文の一部ではない。
    </p>
    <ul class="note">
      <li>この文書は「Aloe パッケージ仕様書」の正本として扱う。</li>
      <li>将来、英語版を作成する場合も、章構成と意味は日本語版と一致させる。</li>
      <li><code>edit-version</code> はこの仕様書専用のカウンタであり、Aloe 言語仕様書や AloeVM 仕様書とは別管理とする。</li>
      <li>仕様本文（サンプル JSON を含む）の意味が変わる修正を行った場合のみ <code>edit-version</code> を +1 する。</li>
      <li>既にユーザーが提示した最新版 HTML を常に正とし、それに対する最小限の差分だけを適用する。</li>
      <li>ビルドツール仕様（<code>aloec</code> の引数など）をこの文書に勝手に書き足さない。
          それらは別途「ビルドツール仕様書」で定義する。</li>
    </ul>

  </main>
</div>
</body>
</html>
